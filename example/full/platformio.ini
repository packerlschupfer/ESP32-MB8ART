; PlatformIO Project Configuration File
; MB8ART Full Example - Modular Architecture
;
; This example demonstrates production-ready patterns:
; - Modular initialization (SystemInitializer pattern)
; - Proper error handling with Result<T>
; - FreeRTOS task management with watchdog
; - Ethernet networking with OTA updates
; - Clean separation of concerns

[platformio]
default_envs = esp32dev_debug_selective

; -------------------------------------------------------------------
; Shared Environment Settings
[env_defaults]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
framework = arduino
board = esp32dev

; 16MB flash with custom partitions (adjust for your board)
; board_build.flash_size = 16MB
; board_build.partitions = partitions_16MB.csv

monitor_port = /dev/ttyACM0
monitor_speed = 921600
monitor_filters =
    direct
    esp32_exception_decoder
monitor_rts = 0
monitor_dtr = 0

lib_ldf_mode = deep+

; Library dependencies from GitHub
lib_deps =
    ; Foundation
    https://github.com/packerlschupfer/ESP32-LibraryCommon.git
    https://github.com/packerlschupfer/ESP32-Logger.git
    https://github.com/packerlschupfer/ESP32-SemaphoreGuard.git
    https://github.com/packerlschupfer/ESP32-MutexGuard.git

    ; Task management
    https://github.com/packerlschupfer/ESP32-Watchdog.git
    https://github.com/packerlschupfer/ESP32-TaskManager.git

    ; Network
    https://github.com/packerlschupfer/ESP32-EthernetManager.git
    https://github.com/packerlschupfer/ESP32-OTAManager.git

    ; Modbus
    https://github.com/packerlschupfer/esp32ModbusRTU.git#fix/fc2-bytecount
    https://github.com/packerlschupfer/ESP32-IDeviceInstance.git
    https://github.com/packerlschupfer/ESP32-ModbusDevice.git
    https://github.com/packerlschupfer/ESP32-MB8ART.git

lib_ignore =
    WiFi

; -------------------------------------------------------------------
; Base build flags
[base]
build_flags =
    -Wall
    -std=gnu++17
    -I include

    ; Serial buffer for logging
    -D SERIAL_TX_BUFFER_SIZE=1024
    -D SERIAL_RX_BUFFER_SIZE=256

    ; Ethernet configuration (LAN8720)
    -D CONFIG_ETH_ENABLED=1
    -D CONFIG_ETH_USE_ESP32_EMAC=1
    -D ETH_PHY_INTERFACE=ETH_PHY_RMII
    -D ETH_RMII_CLK_OUTPUT=1
    -D ETH_RMII_CLK_OUT_GPIO=17
    -D ETH_PHY_MDC_PIN=23
    -D ETH_PHY_MDIO_PIN=18
    -D ETH_PHY_ADDR=0
    -D ETH_PHY_POWER_PIN=-1

    ; Disable WiFi/BT
    -D CONFIG_WIFI_ENABLED=0
    -D CONFIG_BT_NIMBLE_ENABLED=0

    ; Project config
    -D DEVICE_HOSTNAME=\"esp32-mb8art-full\"
    -D OTA_PASSWORD=\"mb8art-update\"
    -D OTA_PORT=3232

    ; Modbus config
    -D MODBUS_RX_PIN=36
    -D MODBUS_TX_PIN=4
    -D MODBUS_BAUD_RATE=9600
    -D MB8ART_ADDRESS=0x03

    ; Enable custom logger
    -D USE_CUSTOM_LOGGER

; -------------------------------------------------------------------
; Debug Selective - Strategic debug output
[env:esp32dev_debug_selective]
extends = env_defaults
build_type = debug
build_flags =
    ${base.build_flags}
    -D LOG_MODE_DEBUG_SELECTIVE
    -D DEBUG_BUILD
    -D MB8ART_DEBUG_SELECTIVE
    -D MB8ART_HIGH_RESOLUTION=1
    -D CORE_DEBUG_LEVEL=3
    -O0
    -g3

upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; Debug Full - Maximum verbosity
[env:esp32dev_debug_full]
extends = env_defaults
build_type = debug
build_flags =
    ${base.build_flags}
    -D LOG_MODE_DEBUG_FULL
    -D DEBUG_BUILD
    -D MB8ART_DEBUG
    -D MODBUSDEVICE_DEBUG
    -D MODBUS_RTU_DEBUG
    -D MB8ART_HIGH_RESOLUTION=1
    -D CORE_DEBUG_LEVEL=5
    -O0
    -g3

upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; Release - Production optimized
[env:esp32dev_release]
extends = env_defaults
build_type = release
build_flags =
    ${base.build_flags}
    -D LOG_MODE_RELEASE
    -D NDEBUG
    -Os
    -flto

upload_port = /dev/ttyACM0
upload_speed = 921600
